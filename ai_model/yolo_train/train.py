from ultralytics import YOLO

def main():
    # ==========================================
    # 1. ëª¨ë¸ ì„¤ì •
    # ==========================================
    # yolov8n.pt: ì´ë¯¸ ë˜‘ë˜‘í•œ ëª¨ë¸(Pre-trained)ì„ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
    print("â–¶ ëª¨ë¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...")
    model = YOLO('yolov8n.pt') 

    # ==========================================
    # 2. í•™ìŠµ ì‹œì‘ (Training)
    # ==========================================
    # data: data.yaml íŒŒì¼ì˜ ìœ„ì¹˜ (ì ˆëŒ€ ê²½ë¡œë¥¼ ì¶”ì²œí•©ë‹ˆë‹¤)
    # epochs: ê³µë¶€ ë°˜ë³µ íšŸìˆ˜ (50ë²ˆ ì •ë„ë©´ ì¶©ë¶„)
    # imgsz: ì´ë¯¸ì§€ í¬ê¸° (640ì´ êµ­ë£°)
    # device: 0 (ê·¸ë˜í”½ì¹´ë“œ ì‚¬ìš©), cpu (ëŠë¦¼)
    print("â–¶ í•™ìŠµì„ ì‹œì‘í•©ë‹ˆë‹¤! (ì´ ê³¼ì •ì€ ì‹œê°„ì´ ê±¸ë¦½ë‹ˆë‹¤)")
    results = model.train(
        data='../../dataset/data.yaml',  # ìƒëŒ€ ê²½ë¡œ (ìƒí™©ì— ë§ê²Œ ìˆ˜ì • í•„ìš”)
        epochs=50,
        imgsz=640,
        batch=16,
        patience=10,      # ì„±ëŠ¥ì´ ì•ˆ ì˜¤ë¥´ë©´ 10ë²ˆ ê¸°ë‹¤ë¦¬ë‹¤ ì¡°ê¸° ì¢…ë£Œ
        device=0,         # GPU ì‚¬ìš© (RTX 5060)
        project='A-PAS_Project',
        name='crosswalk_model',
        exist_ok=True
    )
    print("âœ… í•™ìŠµ ì™„ë£Œ!")

    # ==========================================
    # 3. ë¼ì¦ˆë² ë¦¬ íŒŒì´ìš© ë³€í™˜ (Export)
    # ==========================================
    # í•™ìŠµëœ ìµœê³  ì„±ëŠ¥ ëª¨ë¸(best.pt)ì„ Coral TPUìš©(tflite)ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
    print("â–¶ Coral TPUìš©ìœ¼ë¡œ ë³€í™˜ì„ ì‹œì‘í•©ë‹ˆë‹¤...")
    
    # í•™ìŠµëœ ëª¨ë¸ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
    best_model = YOLO('A-PAS_Project/crosswalk_model/weights/best.pt')
    
    # Edge TPU í¬ë§·ìœ¼ë¡œ ë‚´ë³´ë‚´ê¸° (int8 ì–‘ìí™” í¬í•¨)
    best_model.export(format='edgetpu')
    
    print("ğŸ‰ ëª¨ë“  ì‘ì—…ì´ ëë‚¬ìŠµë‹ˆë‹¤!")
    print("ìƒì„±ëœ 'best_full_integer_quant_edgetpu.tflite' íŒŒì¼ì„ ë¼ì¦ˆë² ë¦¬ íŒŒì´ë¡œ ì˜®ê¸°ì„¸ìš”.")

if __name__ == '__main__':
    main()